<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recuperação de Senha</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title mb-3">Recuperação de Senha</h5>
              <div id="info" class="mb-3"></div>
              <form id="form" class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Nova Senha</label>
                  <input id="password" type="password" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Confirmar Nova Senha</label>
                  <input id="confirm_password" type="password" class="form-control" required>
                </div>
                <div class="col-12">
                  <button id="btn-confirm" class="btn btn-primary" type="submit">Confirmar</button>
                  <button id="btn-close" class="btn btn-outline-secondary" type="button">Fechar página</button>
                </div>
              </form>
              <div id="req" class="mt-3"></div>
              <div id="resp" class="mt-2"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      function el(tag, cls, html){ const e=document.createElement(tag); if(cls) e.className=cls; if(html!=null) e.innerHTML=html; return e; }
      function pre(obj){ const p=el('pre','bg-body-tertiary p-2 rounded border'); try{ p.textContent=JSON.stringify(obj,null,2);}catch{ p.textContent=String(obj);} return p; }
      function alertEl(kind, text){ return el('div', `alert alert-${kind} py-2` , text); }
      async function postJSON(url, body){ const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)}); const t=await res.text(); let d=t; try{ d=t?JSON.parse(t):null }catch{} if(!res.ok) throw {status:res.status, url, data:d}; return d; }

      const info = document.getElementById('info');
      const form = document.getElementById('form');
      const req = document.getElementById('req');
      const resp = document.getElementById('resp');
      const inputPassword = document.getElementById('password');
      const inputConfirm = document.getElementById('confirm_password');
      const btnClose = document.getElementById('btn-close');
      btnClose.addEventListener('click', ()=>{ window.close(); });

      let code = '';
      let login = '';

      (function init(){
        try{
          const url = new URL(window.location.href);
          const path = (url.pathname||'').replace(/\/$/, '');
          const isResetPath = path === '/user/auth/verify-password' || path.endsWith('/user/auth/verify-password');
          const p = url.searchParams;
          code = p.get('code') || '';
          login = p.get('login') || '';
          if((!code || !login) && url.hash){ const hp=new URLSearchParams(url.hash.replace(/^#/,'')); code = code || hp.get('code') || ''; login = login || hp.get('login') || ''; }
          if(!isResetPath){ info.replaceChildren(alertEl('danger','Caminho inválido para recuperação de senha.')); form.classList.add('d-none'); return; }
          if(!code || !login){ info.replaceChildren(alertEl('danger','Link de recuperação incompleto: faltam parâmetros.')); form.classList.add('d-none'); return; }
          info.replaceChildren(pre({ login, code_hint: code ? (code.slice(0,6)+'…'+code.slice(-4)) : '' }));
        }catch(e){
          info.replaceChildren(alertEl('danger','Não foi possível processar a URL atual.')); form.classList.add('d-none');
        }
      })();

      form.addEventListener('submit', async (ev)=>{
        ev.preventDefault();
        const password = String(inputPassword.value||'');
        const confirm_password = String(inputConfirm.value||'');
        if(!password || !confirm_password){ resp.replaceChildren(alertEl('danger','Senha e confirmação são obrigatórias.')); return; }
        if(password !== confirm_password){ resp.replaceChildren(alertEl('danger','As senhas não coincidem.')); return; }
        const urlAPI = `/api/user/auth/verify-password?login=${encodeURIComponent(login)}&code=${encodeURIComponent(code)}`;
        req.replaceChildren(pre({ url: urlAPI, method: 'POST', body: { password: '***', confirm_password: '***' } }));
        resp.replaceChildren(alertEl('info','Enviando...'));
        try{
          const data = await postJSON(urlAPI, { password, confirm_password });
          resp.replaceChildren(alertEl('success','Senha redefinida com sucesso. Você pode fechar esta página.'), pre(data));
        }catch(err){
          resp.replaceChildren(alertEl('danger','Falha ao redefinir senha'), pre(err));
        }
      });
    </script>
  </body>
  </html>

