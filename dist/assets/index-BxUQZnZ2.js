(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))u(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&u(l)}).observe(document,{childList:!0,subtree:!0});function d(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function u(o){if(o.ep)return;o.ep=!0;const i=d(o);fetch(o.href,i)}})();const P="users_spa_tokens_v1";function M(){try{return JSON.parse(localStorage.getItem(P)||"{}")}catch{return{}}}function I(e){localStorage.setItem(P,JSON.stringify(e||{}))}function $(){localStorage.removeItem(P)}const H="/api";async function b(e,n={}){const d=e.startsWith("http")?e:H.replace(/\/$/,"")+e,u={"Content-Type":"application/json",...n.headers},o=M();n.auth&&o.access_token&&(u.Authorization=`Bearer ${o.access_token}`);const i=await fetch(d,{...n,headers:u,body:n.body?JSON.stringify(n.body):void 0});let l;try{l=await i.json()}catch{l=await i.text()}if(!i.ok)throw{status:i.status,data:l};return l}const f={login:e=>b("/user/auth/token",{method:"POST",body:e}),refresh:e=>b("/user/auth/token/refresh",{method:"POST",body:{refresh_token:e}}),verify:e=>b("/user/auth/verify",{method:"POST",body:e}),verifyLink:e=>`${H}/user/auth/verify-link?login=${encodeURIComponent(e.login)}&code=${encodeURIComponent(e.code)}`,resendCode:e=>b("/user/auth/verification-code",{method:"POST",body:e}),recovery:e=>b("/user/auth/password-recovery",{method:"POST",body:e}),listSpaces:()=>b("/user/spaces",{auth:!0}),createSpace:e=>b("/user/spaces",{method:"POST",auth:!0,body:e})};function t(e,n,d){const u=document.createElement(e);return n&&(u.className=n),d&&(u.innerHTML=d),u}function v(e,n){const d=t("div","card mb-3"),u=t("div","card-body"),o=t("h5","card-title",e);return u.append(o,n),d.append(u),d}function c(e,n){return t("div",`alert alert-${e} py-2 mb-2`,n)}function p(e){const n=t("pre","bg-body-tertiary p-2 rounded border");return n.textContent=(()=>{try{return JSON.stringify(e,null,2)}catch{return String(e)}})(),n}function A(){const e=document.getElementById("app");e.innerHTML="";const n=t("ul","nav nav-tabs"),d=t("div","tab-content pt-3"),u=[{id:"login",label:"Login"},{id:"verify",label:"Verificar"},{id:"recovery",label:"Recuperar Senha"},{id:"spaces",label:"UsersSpaces"}];function o(a,s,r){const N=t("li","nav-item"),k=t("a","nav-link"+(r?" active":""),s);return k.href="#",k.addEventListener("click",R=>{R.preventDefault(),d.querySelectorAll(".tab-pane").forEach(q=>q.classList.remove("active","show")),n.querySelectorAll(".nav-link").forEach(q=>q.classList.remove("active")),document.getElementById(`pane-${a}`).classList.add("active","show"),k.classList.add("active")}),N.append(k),N}u.forEach((a,s)=>n.append(o(a.id,a.label,s===0))),e.append(n);const i=t("div","tab-pane fade show active");i.id="pane-login";const l=t("form","row g-2");l.innerHTML=`
    <div class="col-md-4"><label class="form-label">Username</label><input name="username" class="form-control" required></div>
    <div class="col-md-4"><label class="form-label">Password</label><input name="password" type="password" class="form-control" required></div>
    <div class="col-12"><button class="btn btn-primary" type="submit">Entrar</button> <button id="btn-refresh" class="btn btn-secondary" type="button">Refresh Token</button> <button id="btn-logout" class="btn btn-outline-danger" type="button">Sair</button></div>
  `;const m=t("div");l.addEventListener("submit",async a=>{a.preventDefault();const s=new FormData(l);try{const r=await f.login({username:String(s.get("username")),password:String(s.get("password"))});I(r),m.replaceChildren(c("success","Login ok"),p(r))}catch(r){m.replaceChildren(c("danger","Falha no login"),p(r))}}),l.querySelector("#btn-refresh").addEventListener("click",async()=>{const a=M();if(!a.refresh_token){m.replaceChildren(c("danger","Sem refresh_token"));return}try{const s=await f.refresh(a.refresh_token);I(s),m.replaceChildren(c("success","Refresh ok"),p(s))}catch(s){m.replaceChildren(c("danger","Falha no refresh"),p(s))}}),l.querySelector("#btn-logout").addEventListener("click",()=>{$(),m.replaceChildren(c("success","Sessão encerrada"))}),i.append(v("Login",t("div","","")),l,m);const E=t("div","tab-pane fade");E.id="pane-verify";const g=t("form","row g-2");g.innerHTML=`
    <div class="col-md-4"><label class="form-label">Código</label><input name="code" class="form-control" required></div>
    <div class="col-md-4"><label class="form-label">Senha atual</label><input name="password" type="password" class="form-control" required></div>
    <div class="col-12"><button class="btn btn-primary" type="submit">Verificar</button></div>
  `;const y=t("div");g.addEventListener("submit",async a=>{a.preventDefault();const s=new FormData(g);try{const r=await f.verify({code:String(s.get("code")),password:String(s.get("password"))});y.replaceChildren(c("success","Conta verificada"),p(r))}catch(r){y.replaceChildren(c("danger","Falha na verificação"),p(r))}});const S=t("form","row g-2");S.innerHTML=`
    <div class="col-md-4"><label class="form-label">Login</label><input name="login" class="form-control" required></div>
    <div class="col-md-4"><label class="form-label">Código</label><input name="code" class="form-control" required></div>
    <div class="col-12"><button class="btn btn-secondary" type="submit">Abrir Link</button></div>
  `,S.addEventListener("submit",a=>{a.preventDefault();const s=new FormData(S),r=f.verifyLink({login:String(s.get("login")),code:String(s.get("code"))});window.open(r,"_blank")});const w=t("form","row g-2");w.innerHTML=`
    <div class="col-md-4"><label class="form-label">Login</label><input name="login" class="form-control" required></div>
    <div class="col-12"><button class="btn btn-outline-primary" type="submit">Reenviar Código</button></div>
  `,w.addEventListener("submit",async a=>{a.preventDefault();const s=new FormData(w);try{const r=await f.resendCode({login:String(s.get("login"))});y.replaceChildren(c("success","Código reenviado"),p(r))}catch(r){y.replaceChildren(c("danger","Falha ao reenviar"),p(r))}}),E.append(v("Verificar (código + senha)",g),v("Verificar via Link",S),v("Reenviar Código",w),y);const O=t("div","tab-pane fade");O.id="pane-recovery";const L=t("form","row g-2");L.innerHTML=`
    <div class="col-md-5"><label class="form-label">Email</label><input name="email" type="email" class="form-control" required></div>
    <div class="col-12"><button class="btn btn-primary" type="submit">Enviar</button></div>
  `;const T=t("div");L.addEventListener("submit",async a=>{a.preventDefault();const s=new FormData(L);try{const r=await f.recovery({email:String(s.get("email"))});T.replaceChildren(c("success","Se existir, e-mail enviado"),p(r))}catch(r){T.replaceChildren(c("danger","Falha ao recuperar"),p(r))}}),O.append(v("Recuperar Senha",L),T);const F=t("div","tab-pane fade");F.id="pane-spaces";const D=t("div","d-flex gap-2"),_=t("button","btn btn-outline-secondary","Listar Espaços");_.addEventListener("click",async()=>{try{const a=await f.listSpaces();h.replaceChildren(c("success","Espaços listados"),p(a))}catch(a){h.replaceChildren(c("danger","Falha ao listar"),p(a))}});const C=t("form","d-flex gap-2 align-items-end");C.innerHTML=`
    <div><label class="form-label">Nome</label><input name="name" class="form-control" required></div>
    <div><button class="btn btn-primary" type="submit">Criar</button></div>
  `;const h=t("div");C.addEventListener("submit",async a=>{a.preventDefault();const s=new FormData(C);try{const r=await f.createSpace({name:String(s.get("name"))});h.replaceChildren(c("success","Espaço criado"),p(r))}catch(r){h.replaceChildren(c("danger","Falha ao criar (requer tools_role=admin)"),p(r))}}),D.append(_,C),F.append(v("UsersSpaces",D),h),d.append(i,E,O,F),e.append(d)}A();
